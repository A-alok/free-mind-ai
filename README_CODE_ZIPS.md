# Code Zip Storage System

This system automatically stores generated code as zip files in Cloudinary and manages download links in MongoDB after successful code generation.

## Features

- ✅ Automatic zip creation from generated code
- ✅ Upload to Cloudinary with organized folder structure
- ✅ MongoDB storage with metadata and expiration
- ✅ Download tracking and analytics
- ✅ Tech stack auto-detection
- ✅ User-specific and public code archives
- ✅ Automatic cleanup of expired files
- ✅ REST API for all operations

## Setup

### 1. Environment Variables

Add these to your `.env.local` file:

```bash
# Existing Cloudinary credentials
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# Existing MongoDB connection
MONGODB_URI=your_mongodb_uri

# New: Admin key for cleanup operations
ADMIN_KEY=your_secret_admin_key
```

### 2. Dependencies

The system uses these packages (already installed):
- `archiver` - For creating zip files
- `cloudinary` - For cloud storage
- `mongoose` - For MongoDB operations

## How It Works

### Automatic Storage (After Code Generation)

When code is successfully generated via `/api/process`, the system automatically:

1. **Creates a zip** from the generated files
2. **Uploads to Cloudinary** in the `freemind-code-zips/{userId}/` folder
3. **Stores metadata** in MongoDB with:
   - Project information
   - File details
   - Tech stack (auto-detected)
   - Expiration date (30 days default)
   - Download tracking

### Manual Storage

You can also manually store code using the API:

```javascript
const response = await fetch('/api/code-zips', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    generatedFiles: {
      'src/index.js': 'console.log("Hello World");',
      'package.json': '{"name": "my-project", "version": "1.0.0"}',
      'README.md': '# My Project\n\nThis is a sample project.'
    },
    projectName: 'My Awesome Project',
    projectDescription: 'A sample project generated by FreeMind AI',
    userId: 'user123',
    userEmail: 'user@example.com',
    techStack: ['JavaScript', 'Node.js'], // Optional, will be auto-detected
    tags: ['web-app', 'javascript'],
    isPublic: false,
    expirationDays: 30
  })
});

const data = await response.json();
console.log('Zip stored:', data.zipId, data.downloadUrl);
```

## API Endpoints

### Code Zips Management

#### List Code Zips
```bash
GET /api/code-zips?userId=user123&limit=10&skip=0&stats=true
GET /api/code-zips?public=true&limit=10  # Public zips
```

#### Store Code as Zip
```bash
POST /api/code-zips
# Body: { generatedFiles, projectName, projectDescription, userId, ... }
```

#### Get Specific Code Zip
```bash
GET /api/code-zips/[zipId]?userId=user123
```

#### Download Code Zip
```bash
GET /api/code-zips/[zipId]/download?userId=user123
# Returns: { downloadUrl, fileName, downloadCount, ... }
```

#### Delete Code Zip
```bash
DELETE /api/code-zips/[zipId]?userId=user123&hardDelete=false
```

### Admin Operations

#### Cleanup Expired Zips
```bash
POST /api/admin/code-zips
{
  "action": "cleanup",
  "adminKey": "your_admin_key",
  "hardDelete": true  # Also delete from Cloudinary
}
```

#### Get Statistics
```bash
POST /api/admin/code-zips
{
  "action": "statistics",
  "adminKey": "your_admin_key"
}
```

## Integration with Existing Code Generation

The process endpoint (`/api/process`) has been enhanced to automatically store generated code. You can pass additional parameters:

```javascript
const formData = new FormData();
formData.append('text_prompt', 'Create a React todo app');
formData.append('task_type', 'code_generation');
formData.append('user_id', 'user123');
formData.append('user_email', 'user@example.com');
formData.append('project_name', 'Todo App');
formData.append('project_description', 'A simple React todo application');
formData.append('is_public', 'false');

const response = await fetch('/api/process', {
  method: 'POST',
  body: formData
});

const data = await response.json();

// Response now includes:
console.log(data.codeZip); // { zipId, downloadUrl, expiresAt, message }
```

## React Component Usage

```jsx
import CodeZipManager from '../components/CodeZipManager';

function MyPage() {
  return (
    <div>
      <h1>My Generated Projects</h1>
      <CodeZipManager 
        userId="user123" 
        userEmail="user@example.com" 
      />
    </div>
  );
}
```

## Database Schema

### CodeZip Collection

```javascript
{
  _id: ObjectId,
  projectName: String,
  projectDescription: String,
  userId: String,
  userEmail: String,
  zipFileName: String,
  zipSize: Number,
  cloudinaryUrl: String,
  cloudinaryPublicId: String,
  cloudinaryFolder: String,
  generatedFiles: [{
    fileName: String,
    fileType: String,
    filePath: String
  }],
  techStack: [String],
  generationParameters: {
    model: String,
    prompt: String,
    taskType: String,
    additionalSettings: Mixed
  },
  downloadCount: Number,
  lastDownloadedAt: Date,
  status: 'active' | 'archived' | 'deleted',
  expiresAt: Date,
  tags: [String],
  isPublic: Boolean,
  createdAt: Date,
  updatedAt: Date
}
```

## Cloudinary Organization

Files are stored in this structure:
```
freemind-code-zips/
├── user123/
│   ├── My_Project_2024-01-15T10-30-00-000Z.zip
│   └── Another_Project_2024-01-16T14-22-15-000Z.zip
└── user456/
    └── User456_Project_2024-01-17T09-15-30-000Z.zip
```

## Features in Detail

### Tech Stack Auto-Detection

The system automatically detects technologies used based on:
- File extensions (`.js`, `.py`, `.java`, etc.)
- File names (`package.json`, `requirements.txt`, etc.)
- File contents (framework imports, specific patterns)

### Expiration and Cleanup

- Default expiration: 30 days
- Automatic cleanup marks expired files as `deleted`
- Admin can trigger hard deletion from Cloudinary
- Users can extend expiration periods

### Download Tracking

- Each download is tracked and counted
- Last download timestamp is recorded
- Statistics available for users and admins

### Security

- User-based access control
- Public/private project settings
- Admin key protection for sensitive operations
- Automatic expiration prevents unlimited storage

## Maintenance

### Regular Cleanup (Recommended)

Set up a cron job or scheduled task to run cleanup:

```bash
curl -X POST http://localhost:3000/api/admin/code-zips \
  -H "Content-Type: application/json" \
  -d '{"action": "cleanup", "adminKey": "your_admin_key", "hardDelete": true}'
```

### Monitor Usage

Check statistics regularly:

```bash
curl -X POST http://localhost:3000/api/admin/code-zips \
  -H "Content-Type: application/json" \
  -d '{"action": "statistics", "adminKey": "your_admin_key"}'
```

## Error Handling

The system gracefully handles failures:
- Code generation succeeds even if zip storage fails
- Warnings are returned instead of errors
- Expired files return 410 Gone status
- Proper error messages for debugging

## Future Enhancements

Potential improvements:
- Bulk download of multiple projects
- Project templates from popular archives
- Integration with GitHub/GitLab
- Advanced search and filtering
- Collaborative projects
- Code preview without download